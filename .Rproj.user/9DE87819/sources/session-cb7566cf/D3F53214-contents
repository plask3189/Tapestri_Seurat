
```{r}
library(rhdf5)
library(Seurat)
library(ggplot2)
library(tidyr)
library(Matrix)
library(httr)
library(jsonlite)
library(dplyr)
source("get_variants.R") # get_variants_data
source("annotate_variants.R")
source("generate_seurat_object.R")
source("droplet_analysis.R")
```


Load sample and obtain sample data 
```{r}
FILE <- "/Users/kateplas/Library/Mobile Documents/com~apple~CloudDocs/Documents/Miles_Lab/BRAF/Pt_H.dna+protein.h5"
panel_extract<-rhdf5::h5read(FILE, "/assays/dna_read_counts/metadata/panel_name")[1]
```

Filter variants because we only want to look at varaints that are interesting. Those are the not WT ones. WT is specified as VAF lower than like 25 i think. 50 is HET and 100 is HOM. 
```{r}
variants_data<- get_variants_data(FILE, min_VAF_cutoff = 1, min_genotyping_rate = 85)

ggplot(variants_data, aes(x = VAF)) +
    geom_histogram(bins = 50, fill = "steelblue", color = "white") +
    labs(title = "Distribution of Variant Allele Frequency (VAF)", x = "VAF (%)", y = "Count")

anns<- annotate_variants(FILE, panel = panel_extract) # get like if coding, exon, and AA change.

variants_data_to_use <- select_variants(variants_data, anns)
```


# make seurat object using selected variants.
```{r}
seurat_obj <- generate_seurat_object(FILE, variants_data_to_use)
```

# Protein Normalization.
We do this by comparing empty vs not cells, so we work with the all_barcodes section of the h5 file. 

```{r}
droplet_metadata<- get_all_droplet_data(FILE)
background_droplets<-droplet_metadata%>% dplyr::filter(Droplet_type=="Empty")%>%  dplyr::filter(dna_size<1.5&dna_size>0.15)%>%pull(Cell)
all_cells_protein_matrix<- h5read(FILE, "all_barcodes/protein_read_counts/layers/read_counts")
colnames(all_cells_protein_matrix) <- h5read(FILE, "all_barcodes/protein_read_counts/ra/barcode") |> as.character() |> gsub("-1", "", x = _)
rownames(all_cells_protein_matrix) <- as.character(h5read(FILE, "all_barcodes/protein_read_counts/ca/id"))

# split into one matrix with empty cells (group_background_droplets) 
empty_drops_matrix_input<- all_cells_protein_matrix[,background_droplets]
protein_matrix<- all_cells_protein_matrix[,h5read(FILE, "assays/dna_variants/ra/barcode")]

isotype <- grep("IgG",rownames(protein_matrix),value=TRUE) # vector of isotype control names
dsb_norm <- dsb::DSBNormalizeProtein( # remove ambient protien noise reflected in counts from empty droplets
    cell_protein_matrix = protein_matrix, # cell-containing droplet raw protein count matrix
    empty_drop_matrix = empty_drops_matrix_input, # empty/background droplet raw protein count
    denoise.counts = TRUE, # (default = TRUE); run step II
    use.isotype.control = TRUE, # (default = TRUE): use isotype controls to define technical components.
    isotype.control.name.vec = isotype # isotype controls (IgG markers) to adjust for non-specific antibody binding
)
dsb_norm_assay <- CreateAssay5Object(counts = dsb_norm)
seurat_obj[["DSB_norm"]] <- dsb_norm_assay
DefaultAssay(seurat_obj) <- "DSB_norm"
```


```{r}

seurat_obj <- Seurat::ScaleData(seurat_obj,assay = "DSB_norm", layer = "counts")
seurat_obj<- Seurat::RunPCA(seurat_obj, features = rownames(seurat_obj@assays[["DSB_norm"]]))
seurat_obj<- FindNeighbors(object = seurat_obj, k.param = 30)
seurat_obj<- FindClusters(object = seurat_obj, # direct graph clustering
                      assay = "DSB_norm",
                      resolution = 0.5,
                      algorithm = 3,
                      verbose = TRUE)
seurat_obj<- RunUMAP(object = seurat_obj,
                 seed.use = 1333,
                 min.dist = 0.4, 
                 n.neighbors = 30,
                 features=rownames(seurat_obj@assays[["DSB_norm"]]),
                 verbose = TRUE)

umap_preview<- DimPlot(seurat_obj, reduction = "umap",label = TRUE, label.size = 6); umap_preview
```










